<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stationery Bill Calculator & Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Global Styles */
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7ff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f8 100%);
    }
    
    h1, h2, h3 {
      color: var(--primary);
      font-weight: 600;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Preloader Styles */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 0.8s ease-out;
    }
    
    .preloader-logo {
      width: 120px;
      height: 120px;
      background: white;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: preloaderPulse 2s infinite alternate;
    }
    
    .preloader-text {
      margin-top: 20px;
      font-size: 24px;
      font-weight: 600;
      color: white;
      text-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: textFade 2s infinite alternate;
    }
    
    .progress-bar {
      width: 200px;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      width: 0%;
      background: white;
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    /* Logo Styles */
    .logo-container {
      text-align: center;
      margin: 20px 0 30px;
    }
    
    .logo {
      display: inline-block;
      width: 120px;
      height: 120px;
      position: relative;
      transform-style: preserve-3d;
      animation: logoFloat 6s ease-in-out infinite;
    }
    
    .logo-inner {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      box-shadow: 0 10px 30px rgba(67, 97, 238, 0.3);
      color: white;
      font-size: 50px;
      backface-visibility: hidden;
    }
    
    .logo-text {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-top: 15px;
      background: linear-gradient(to right, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: textGlow 2s ease-in-out infinite alternate;
    }
    
    /* Container Styles */
    .container {
      width: 85%;
      max-width: 900px;
      margin: 20px auto;
      background-color: white;
      padding: 30px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.08);
      border-radius: 15px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      transform: translateY(0);
      opacity: 1;
    }
    
    .container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
      background-size: 200% 200%;
      animation: gradientBG 3s ease infinite;
    }
    
    .container:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }
    
    .container input {
      padding: 14px 20px;
      margin: 12px 0;
      width: 100%;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }
    
    .container input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(72, 149, 239, 0.2);
      outline: none;
      background-color: white;
    }
    
    .container button {
      padding: 14px 28px;
      margin: 10px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .container button::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
      transform: translateX(-100%);
      transition: transform 0.4s ease;
    }
    
    .container button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
    }
    
    .container button:hover::after {
      transform: translateX(100%);
    }
    
    .container button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 10px rgba(67, 97, 238, 0.3);
    }
    
    /* Table Styles */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 20px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      border-radius: 10px;
      overflow: hidden;
    }
    
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      transition: all 0.2s ease;
    }
    
    th {
      background-color: var(--primary);
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    
    tr:not(:first-child):hover {
      background-color: #f8f9fa;
      transform: translateX(5px);
    }
    
    /* Bill Display Styles */
    #billDisplay, #historyDisplay, #adminHistoryDisplay {
      margin-top: 25px;
      display: none;
      animation: fadeInUp 0.6s ease-out;
    }
    
    .password-toggle-icon {
      cursor: pointer;
      margin-left: -40px;
      position: relative;
      top: -38px;
      opacity: 0.6;
      transition: all 0.2s ease;
      font-size: 20px;
    }
    
    .password-toggle-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .button-group {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    
    .error {
      color: var(--danger);
      font-size: 14px;
      margin-top: -8px;
      margin-bottom: 10px;
      animation: shake 0.5s ease;
    }
    
    /* User Details Styles */
    .section {
      margin-top: 30px;
      border-top: 1px solid #e9ecef;
      padding-top: 20px;
    }
    
    .toggle-btn {
      margin: 15px 0;
      background: linear-gradient(135deg, #6c757d, #495057);
    }
    
    .toggle-btn:hover {
      background: linear-gradient(135deg, #5a6268, #343a40);
    }
    
    /* Success messages */
    .success-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
      color: #0c5460;
      padding: 16px 30px;
      border-radius: 50px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      z-index: 1000;
      animation: slideInDown 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                 fadeOut 0.6s ease-out 3.5s forwards;
      display: flex;
      align-items: center;
      font-weight: 500;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .success-message::before {
      margin-right: 12px;
      font-size: 22px;
    }
    
    .welcome-message::before {
      content: "✋";
    }
    
    .bill-success-message::before {
      content: "✓";
      color: var(--success);
    }
    
    .register-success-message::before {
      content: "🎉";
    }
    
    /* Change password section */
    .change-password-section {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px dashed #dee2e6;
      display: none;
      animation: fadeIn 0.6s ease-out;
    }
    
    .change-password-btn {
      background: linear-gradient(135deg, var(--accent), #3a86ff);
    }
    
    .change-password-btn:hover {
      background: linear-gradient(135deg, #3a86ff, #3a0ca3);
    }
    
    /* Animations */
    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(20px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes logoFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    
    @keyframes textGlow {
      from { text-shadow: 0 0 5px rgba(67, 97, 238, 0.3); }
      to { text-shadow: 0 0 15px rgba(67, 97, 238, 0.5); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(2.5); opacity: 0; }
    }
    
    @keyframes preloaderPulse {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(255,255,255,0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    
    @keyframes textFade {
      0% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    @keyframes introSlide {
      0% { transform: translateY(50px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes introFadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    .pulse-animation {
      animation: pulse 1.5s infinite;
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple-effect {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        width: 95%;
        padding: 20px;
      }
      
      .logo {
        width: 90px;
        height: 90px;
      }
      
      .logo-text {
        font-size: 22px;
      }
      
      .container button {
        padding: 12px 20px;
        font-size: 14px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div class="preloader-logo">
      <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
        <path d="M2 2l7.586 7.586"></path>
        <circle cx="11" cy="11" r="2"></circle>
        <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
      </svg>
    </div>
    <div class="preloader-text">Loading SBC</div>
    <div class="progress-bar">
      <div class="progress"></div>
    </div>
  </div>

  <!-- Success Messages -->
  <div id="welcomeMessage" class="success-message welcome-message" style="display: none;">
    Welcome to Stationery Bill Calculator!
  </div>
  <div id="billSuccessMessage" class="success-message bill-success-message" style="display: none;">
    Bill generated successfully!
  </div>
  <div id="registerSuccessMessage" class="success-message register-success-message" style="display: none;">
    Registration successful! You can now log in.
  </div>

  <!-- Welcome Page -->
  <div id="welcomePage" class="container animate__animated animate__fadeIn" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Welcome to Stationery Bill Calculator</h1>
    <p class="animate__animated animate__fadeIn">Manage your stationery purchases with ease</p>
    <div class="button-group">
      <button onclick="showRegistration()" class="animate__animated animate__fadeInLeft ripple">First-time User</button>
      <button onclick="showLogin()" class="animate__animated animate__fadeInRight ripple">Existing User</button>
      <button onclick="showAdminRegistration()" class="animate__animated animate__fadeInLeft ripple">Admin Registration</button>
      <button onclick="showAdminLogin()" class="animate__animated animate__fadeInRight ripple">Admin Login</button>
    </div>
  </div>

  <!-- User Registration Page -->
  <div id="registrationPage" class="container" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Register</h1>
    <input type="text" id="regUsername" placeholder="Create Username" required class="animate__animated animate__fadeIn">
    <input type="password" id="regPassword" placeholder="Create Password (min 6 characters)" required class="animate__animated animate__fadeIn">
    <i class="password-toggle-icon" onclick="togglePassword('regPassword')">👁️</i>
    <div id="regError" class="error"></div>
    <div class="button-group">
      <button onclick="register()" class="animate__animated animate__fadeInUp ripple">Register</button>
      <button onclick="showWelcome()" class="animate__animated animate__fadeInUp ripple">Back</button>
    </div>
  </div>

  <!-- User Login Page -->
  <div id="loginPage" class="container" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Login</h1>
    <input type="text" id="username" placeholder="Username" required class="animate__animated animate__fadeIn">
    <input type="password" id="password" placeholder="Password" required class="animate__animated animate__fadeIn">
    <i class="password-toggle-icon" onclick="togglePassword('password')">👁️</i>
    <div id="loginError" class="error"></div>
    <div class="button-group">
      <button onclick="login()" class="animate__animated animate__fadeInUp ripple">Login</button>
      <button onclick="showWelcome()" class="animate__animated animate__fadeInUp ripple">Back</button>
    </div>
    
    <!-- Change Password Section -->
    <div class="change-password-section" id="userChangePasswordSection">
      <h3>Change Password</h3>
      <input type="password" id="currentUserPassword" placeholder="Current Password">
      <input type="password" id="newUserPassword" placeholder="New Password (min 6 characters)">
      <input type="password" id="confirmUserPassword" placeholder="Confirm New Password">
      <div id="userPasswordError" class="error"></div>
      <div class="button-group">
        <button onclick="changeUserPassword()" class="change-password-btn ripple">Change Password</button>
      </div>
    </div>
    <div class="button-group">
      <button onclick="toggleChangePassword('userChangePasswordSection')" class="change-password-btn ripple">Change Password</button>
    </div>
  </div>
  
  <!-- Main Content: Stationery Bill Calculator -->
  <div id="mainContent" class="container" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Stationery Bill Calculator</h1>
    <div id="noItemsMessage" style="display: none; color: var(--danger);" class="animate__animated animate__shakeX">
      No items available. Please contact admin to add items.
    </div>
    <table id="itemsTable" style="display: none;" class="animate__animated animate__fadeIn">
      <thead>
        <tr>
          <th>Item</th>
          <th>Price (₹)</th>
          <th>Available Quantity</th>
          <th>Quantity to Buy</th>
        </tr>
      </thead>
      <tbody id="itemTable"></tbody>
    </table>
    <div class="button-group">
      <button onclick="generateBill()" class="animate__animated animate__fadeInUp pulse-animation ripple">Generate Bill</button>
      <button onclick="resetValues()" class="animate__animated animate__fadeInUp ripple">Reset</button>
      <button onclick="viewHistory()" class="animate__animated animate__fadeInUp ripple">View History</button>
      <button onclick="clearHistory()" class="animate__animated animate__fadeInUp ripple">Clear History</button>
      <button onclick="logout()" class="animate__animated animate__fadeInUp ripple">Logout</button>
    </div>
    <div id="billDisplay">
      <h2>Bill Summary</h2>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Amount (₹)</th>
          </tr>
        </thead>
        <tbody id="billContent"></tbody>
      </table>
      <h2>Grand Total: ₹<span id="grandTotal">0</span></h2>
    </div>
    
    <div id="historyDisplay">
      <h2>Calculation History</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Bill</th>
            <th>Grand Total (₹)</th>
          </tr>
        </thead>
        <tbody id="historyContent"></tbody>
      </table>
      <div class="button-group">
        <button onclick="hideHistory()" class="ripple">Close History</button>
      </div>
    </div>
  </div>

  <!-- Admin Registration Page -->
  <div id="adminRegistration" class="container" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Admin Registration</h1>
    <input type="text" id="adminRegUsername" placeholder="Create Admin Username" required class="animate__animated animate__fadeIn">
    <input type="password" id="adminRegPassword" placeholder="Create Admin Password (min 6 characters)" required class="animate__animated animate__fadeIn">
    <i class="password-toggle-icon" onclick="togglePassword('adminRegPassword')">👁️</i>
    <div id="adminRegError" class="error"></div>
    <div class="button-group">
      <button onclick="adminRegister()" class="animate__animated animate__fadeInUp ripple">Register</button>
      <button onclick="showWelcome()" class="animate__animated animate__fadeInUp ripple">Back</button>
    </div>
  </div>

  <!-- Admin Login Page -->
  <div id="adminLogin" class="container" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Admin Login</h1>
    <input type="text" id="adminUsername" placeholder="Admin Username" required class="animate__animated animate__fadeIn">
    <input type="password" id="adminPassword" placeholder="Admin Password" required class="animate__animated animate__fadeIn">
    <i class="password-toggle-icon" onclick="togglePassword('adminPassword')">👁️</i>
    <div id="adminLoginError" class="error"></div>
    <div class="button-group">
      <button onclick="adminLogin()" class="animate__animated animate__fadeInUp ripple">Login</button>
      <button onclick="showWelcome()" class="animate__animated animate__fadeInUp ripple">Back</button>
    </div>
    
    <!-- Change Password Section -->
    <div class="change-password-section" id="adminChangePasswordSection">
      <h3>Change Password</h3>
      <input type="password" id="currentAdminPassword" placeholder="Current Password">
      <input type="password" id="newAdminPassword" placeholder="New Password (min 6 characters)">
      <input type="password" id="confirmAdminPassword" placeholder="Confirm New Password">
      <div id="adminPasswordError" class="error"></div>
      <div class="button-group">
        <button onclick="changeAdminPassword()" class="change-password-btn ripple">Change Password</button>
      </div>
    </div>
    <div class="button-group">
      <button onclick="toggleChangePassword('adminChangePasswordSection')" class="change-password-btn ripple">Change Password</button>
    </div>
  </div>

  <!-- Item Management Page -->
  <div id="itemManagement" class="container" style="display: none;">
    <div class="logo-container">
      <div class="logo">
        <div class="logo-inner">
          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            <path d="M2 2l7.586 7.586"></path>
            <circle cx="11" cy="11" r="2"></circle>
            <line x1="3" y1="22" x2="21" y2="22" stroke-width="3"></line>
          </svg>
        </div>
      </div>
      <div class="logo-text">SBC</div>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Admin Dashboard</h1>
    <h2 class="animate__animated animate__fadeIn">Add New Item</h2>
    <input type="text" id="itemName" placeholder="Item Name" required class="animate__animated animate__fadeIn">
    <input type="number" id="itemPrice" placeholder="Item Price (₹)" min="0" step="0.01" required class="animate__animated animate__fadeIn">
    <input type="number" id="itemQuantity" placeholder="Item Quantity" min="0" required class="animate__animated animate__fadeIn">
    <div id="itemError" class="error"></div>
    <div class="button-group">
      <button onclick="addItem()" class="animate__animated animate__fadeInUp ripple">Add Item</button>
    </div>
    
    <h2 class="animate__animated animate__fadeIn">Existing Items</h2>
    <div id="existingItems" class="animate__animated animate__fadeIn"></div>
    
    <!-- User Management Section -->
    <div class="section animate__animated animate__fadeIn">
      <h2>User Management</h2>
      <button class="toggle-btn animate__animated animate__fadeIn ripple" onclick="toggleUserDetails()">Show User Details</button>
      <div id="userDetails" style="display: none;">
        <h3>Registered Users</h3>
        <table class="user-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Admin History Section -->
    <div class="section animate__animated animate__fadeIn">
      <h2>Bill History Management</h2>
      <button class="toggle-btn animate__animated animate__fadeIn ripple" onclick="toggleAdminHistory()">Show All Bill History</button>
      <div id="adminHistory" style="display: none;">
        <h3>All User Bill History</h3>
        <table class="user-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Date</th>
              <th>Total (₹)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminHistoryTableBody"></tbody>
        </table>
      </div>
    </div>
    
    <div class="button-group">
      <button onclick="removeSelectedItems()" class="animate__animated animate__fadeInUp ripple">Remove Selected Items</button>
      <button onclick="updateExistingItems()" class="animate__animated animate__fadeInUp ripple">Update Selected Items</button>
      <button onclick="adminLogout()" class="animate__animated animate__fadeInUp ripple">Logout</button>
    </div>
    
    <div id="adminHistoryDisplay">
      <h2>Bill Details</h2>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Amount (₹)</th>
          </tr>
        </thead>
        <tbody id="adminHistoryContent"></tbody>
      </table>
      <h2>Grand Total: ₹<span id="adminGrandTotal">0</span></h2>
      <div class="button-group">
        <button onclick="hideAdminHistory()" class="ripple">Close Bill Details</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentUser = localStorage.getItem("currentUser");
    let currentAdmin = localStorage.getItem("currentAdmin");

    // Add ripple effect to buttons
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('ripple')) {
        const btn = e.target;
        const rect = btn.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const ripple = document.createElement('span');
        ripple.classList.add('ripple-effect');
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        
        btn.appendChild(ripple);
        
        setTimeout(() => {
          ripple.remove();
        }, 600);
      }
    });

    // Preloader animation - Modified to check for existing session
    function simulateProgress() {
      const progressBar = document.querySelector('.progress');
      let width = 0;
      const interval = setInterval(() => {
        if (width >= 100) {
          clearInterval(interval);
          document.getElementById('preloader').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('preloader').style.display = 'none';
            checkExistingSession();
          }, 800);
        } else {
          width += Math.random() * 10 + 5;
          if (width > 100) width = 100;
          progressBar.style.width = width + '%';
        }
      }, 300);
    }

    // New function to check existing session
    function checkExistingSession() {
      currentUser = localStorage.getItem("currentUser");
      currentAdmin = localStorage.getItem("currentAdmin");
      
      if (currentAdmin) {
        showItemManagement();
        showSuccessMessage("welcome", "Welcome back, Admin!");
      } else if (currentUser) {
        showMainContent();
        showSuccessMessage("welcome", "Welcome back to SBC!");
      } else {
        showWelcome();
        document.getElementById('welcomePage').style.display = 'block';
        animateElements(document.getElementById('welcomePage'));
        showSuccessMessage("welcome", "Welcome to SBC!");
      }
    }

    // Helper functions
    function hideAllPages() {
      const pages = [
        "welcomePage", "registrationPage", "loginPage", 
        "mainContent", "adminRegistration", "adminLogin", 
        "itemManagement"
      ];
      
      pages.forEach(page => {
        const element = document.getElementById(page);
        if (element) {
          element.style.display = "none";
        }
      });
    }

    function clearErrors() {
      document.querySelectorAll('.error').forEach(el => {
        el.textContent = '';
      });
    }

    function togglePassword(passwordFieldId) {
      const passwordField = document.getElementById(passwordFieldId);
      if (passwordField.type === "password") {
        passwordField.type = "text";
        document.querySelector(`[onclick="togglePassword('${passwordFieldId}')"]`).textContent = "🙈";
      } else {
        passwordField.type = "password";
        document.querySelector(`[onclick="togglePassword('${passwordFieldId}')"]`).textContent = "👁️";
      }
    }

    function formatDate(date) {
      return new Date(date).toLocaleString();
    }

    // Toggle change password section
    function toggleChangePassword(sectionId) {
      const section = document.getElementById(sectionId);
      if (section.style.display === "none") {
        section.style.display = "block";
      } else {
        section.style.display = "none";
      }
    }

    // Show success message
    function showSuccessMessage(type, message) {
      const msgElement = document.getElementById(`${type}Message`);
      if (msgElement) {
        msgElement.textContent = message;
        msgElement.style.display = "flex";
        setTimeout(() => {
          msgElement.style.display = "none";
        }, 3500);
      }
    }

    // User Registration and Login
    function showRegistration() {
      hideAllPages();
      clearErrors();
      const page = document.getElementById("registrationPage");
      page.style.display = "block";
      animateElements(page);
    }

    function showLogin() {
      hideAllPages();
      clearErrors();
      const page = document.getElementById("loginPage");
      page.style.display = "block";
      animateElements(page);
    }

    function showWelcome() {
      hideAllPages();
      clearErrors();
      const page = document.getElementById("welcomePage");
      page.style.display = "block";
      animateElements(page);
    }

    function animateElements(container) {
      const elements = container.querySelectorAll('h1, h2, h3, input, button, table');
      elements.forEach((el, index) => {
        el.classList.add('animate__animated', 'animate__fadeIn');
        el.style.animationDelay = `${index * 0.1}s`;
      });
    }

    function register() {
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      const errorElement = document.getElementById("regError");

      // Validation
      if (!username || !password) {
        errorElement.textContent = "Username and password are required";
        return;
      }
      if (password.length < 6) {
        errorElement.textContent = "Password must be at least 6 characters";
        return;
      }

      if (localStorage.getItem(username)) {
        errorElement.textContent = "Username already exists. Please choose a different username.";
      } else {
        localStorage.setItem(username, password);
        showSuccessMessage("registerSuccess", "Registered successfully! You can now log in.");
        showLogin();
      }
    }

    function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorElement = document.getElementById("loginError");

      if (!username || !password) {
        errorElement.textContent = "Username and password are required";
        return;
      }

      const storedPassword = localStorage.getItem(username);

      if (storedPassword && storedPassword === password) {
        localStorage.setItem("currentUser", username);
        currentUser = username;
        showMainContent();
        showSuccessMessage("welcome", "Welcome back to SBC!");
      } else {
        errorElement.textContent = "Invalid credentials. Please try again.";
      }
    }

    function logout() {
      localStorage.removeItem("currentUser");
      currentUser = null;
      showWelcome();
    }

    // Change user password
    function changeUserPassword() {
      const currentPassword = document.getElementById("currentUserPassword").value;
      const newPassword = document.getElementById("newUserPassword").value;
      const confirmPassword = document.getElementById("confirmUserPassword").value;
      const errorElement = document.getElementById("userPasswordError");
      
      // Validation
      if (!currentUser) {
        errorElement.textContent = "No user logged in";
        return;
      }
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        errorElement.textContent = "All fields are required";
        return;
      }
      
      if (newPassword.length < 6) {
        errorElement.textContent = "New password must be at least 6 characters";
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorElement.textContent = "New passwords don't match";
        return;
      }
      
      const storedPassword = localStorage.getItem(currentUser);
      if (storedPassword !== currentPassword) {
        errorElement.textContent = "Current password is incorrect";
        return;
      }
      
      // Change password
      localStorage.setItem(currentUser, newPassword);
      errorElement.textContent = "";
      showSuccessMessage("welcome", "Password changed successfully!");
      document.getElementById("currentUserPassword").value = "";
      document.getElementById("newUserPassword").value = "";
      document.getElementById("confirmUserPassword").value = "";
      document.getElementById("userChangePasswordSection").style.display = "none";
    }

    // Show main content and hide all other pages
    function showMainContent() {
      hideAllPages();
      const page = document.getElementById("mainContent");
      page.style.display = "block";
      animateElements(page);
      loadItems();
    }

    // Admin Registration and Login
    function showAdminRegistration() {
      hideAllPages();
      clearErrors();
      const page = document.getElementById("adminRegistration");
      page.style.display = "block";
      animateElements(page);
    }

    function showAdminLogin() {
      hideAllPages();
      clearErrors();
      const page = document.getElementById("adminLogin");
      page.style.display = "block";
      animateElements(page);
    }

    function adminRegister() {
      const username = document.getElementById("adminRegUsername").value.trim();
      const password = document.getElementById("adminRegPassword").value.trim();
      const errorElement = document.getElementById("adminRegError");

      // Validation
      if (!username || !password) {
        errorElement.textContent = "Username and password are required";
        return;
      }
      if (password.length < 6) {
        errorElement.textContent = "Password must be at least 6 characters";
        return;
      }

      if (localStorage.getItem(username)) {
        errorElement.textContent = "Admin username already exists. Please choose a different username.";
      } else {
        localStorage.setItem(username, password);
        showSuccessMessage("registerSuccess", "Admin registered successfully! You can now log in.");
        showAdminLogin();
      }
    }

    function adminLogin() {
      const username = document.getElementById("adminUsername").value.trim();
      const password = document.getElementById("adminPassword").value.trim();
      const errorElement = document.getElementById("adminLoginError");

      if (!username || !password) {
        errorElement.textContent = "Username and password are required";
        return;
      }

      const storedPassword = localStorage.getItem(username);

      if (storedPassword && storedPassword === password) {
        localStorage.setItem("currentAdmin", username);
        currentAdmin = username;
        showItemManagement();
        showSuccessMessage("welcome", "Welcome back, Admin!");
      } else {
        errorElement.textContent = "Invalid credentials. Please try again.";
      }
    }

    // Change admin password
    function changeAdminPassword() {
      const currentPassword = document.getElementById("currentAdminPassword").value;
      const newPassword = document.getElementById("newAdminPassword").value;
      const confirmPassword = document.getElementById("confirmAdminPassword").value;
      const errorElement = document.getElementById("adminPasswordError");
      
      // Validation
      if (!currentAdmin) {
        errorElement.textContent = "No admin logged in";
        return;
      }
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        errorElement.textContent = "All fields are required";
        return;
      }
      
      if (newPassword.length < 6) {
        errorElement.textContent = "New password must be at least 6 characters";
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorElement.textContent = "New passwords don't match";
        return;
      }
      
      const storedPassword = localStorage.getItem(currentAdmin);
      if (storedPassword !== currentPassword) {
        errorElement.textContent = "Current password is incorrect";
        return;
      }
      
      // Change password
      localStorage.setItem(currentAdmin, newPassword);
      errorElement.textContent = "";
      showSuccessMessage("welcome", "Admin password changed successfully!");
      document.getElementById("currentAdminPassword").value = "";
      document.getElementById("newAdminPassword").value = "";
      document.getElementById("confirmAdminPassword").value = "";
      document.getElementById("adminChangePasswordSection").style.display = "none";
    }

    function adminLogout() {
      localStorage.removeItem("currentAdmin");
      currentAdmin = null;
      showWelcome();
    }

    function showItemManagement() {
      hideAllPages();
      const page = document.getElementById("itemManagement");
      page.style.display = "block";
      animateElements(page);
      loadItems();
    }

    // Item Management
    function addItem() {
      const name = document.getElementById("itemName").value.trim();
      const price = parseFloat(document.getElementById("itemPrice").value);
      const quantity = parseInt(document.getElementById("itemQuantity").value);
      const errorElement = document.getElementById("itemError");

      // Validation
      if (!name) {
        errorElement.textContent = "Item name is required";
        return;
      }
      if (isNaN(price) || price <= 0) {
        errorElement.textContent = "Please enter a valid price";
        return;
      }
      if (isNaN(quantity) || quantity < 0) {
        errorElement.textContent = "Please enter a valid quantity";
        return;
      }

      const items = JSON.parse(localStorage.getItem("items")) || [];
      
      // Check if item already exists
      const existingItemIndex = items.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
      
      if (existingItemIndex >= 0) {
        // Update existing item
        items[existingItemIndex].price = price;
        items[existingItemIndex].quantity += quantity;
        showSuccessMessage("welcome", `Item "${name}" updated successfully!`);
      } else {
        // Add new item
        items.push({ 
          name, 
          price, 
          quantity 
        });
        showSuccessMessage("welcome", `Item "${name}" added successfully!`);
      }

      localStorage.setItem("items", JSON.stringify(items));

      // Clear form
      document.getElementById("itemName").value = '';
      document.getElementById("itemPrice").value = '';
      document.getElementById("itemQuantity").value = '';
      errorElement.textContent = '';

      loadItems();
      
      // Add animation to the new item
      const itemRows = document.querySelectorAll(".item-row");
      if (itemRows.length > 0) {
        const lastItem = itemRows[itemRows.length - 1];
        lastItem.classList.add("animate__animated", "animate__fadeIn");
      }
    }

    function loadItems() {
      const items = JSON.parse(localStorage.getItem("items")) || [];
      
      // Load items for main content (user view)
      const itemTable = document.getElementById("itemTable");
      const itemsTable = document.getElementById("itemsTable");
      const noItemsMessage = document.getElementById("noItemsMessage");

      itemTable.innerHTML = '';
      
      if (items.length === 0) {
        itemsTable.style.display = "none";
        noItemsMessage.style.display = "block";
      } else {
        itemsTable.style.display = "table";
        noItemsMessage.style.display = "none";
        
        items.forEach((item, index) => {
          const row = `<tr>
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><input type="number" id="quantity-${index}" min="0" max="${item.quantity}" value="0"></td>
          </tr>`;
          itemTable.innerHTML += row;
        });
      }

      // Load items for admin view (item management)
      const existingItems = document.getElementById("existingItems");
      existingItems.innerHTML = '';

      if (items.length === 0) {
        existingItems.innerHTML = '<p>No items available. Please add items.</p>';
      } else {
        items.forEach((item, index) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "item-row";
          itemDiv.style.margin = "5px 0";
          
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `item-${index}`;
          checkbox.className = "item-checkbox";
          
          const label = document.createElement("label");
          label.htmlFor = `item-${index}`;
          label.innerHTML = `
            <strong>${item.name}</strong> - 
            Price: ₹${item.price.toFixed(2)}, 
            Quantity: ${item.quantity}
          `;
          
          itemDiv.appendChild(checkbox);
          itemDiv.appendChild(label);
          existingItems.appendChild(itemDiv);
        });
      }
    }

    function removeSelectedItems() {
      const items = JSON.parse(localStorage.getItem("items")) || [];
      const checkboxes = document.querySelectorAll(".item-checkbox:checked");
      
      if (checkboxes.length === 0) {
        showSuccessMessage("welcome", "Please select at least one item to remove.");
        return;
      }
      
      // Get indices of selected items
      const indicesToRemove = Array.from(checkboxes).map(checkbox => 
        parseInt(checkbox.id.split("-")[1])
      );
      
      // Filter out selected items
      const updatedItems = items.filter((_, index) => 
        !indicesToRemove.includes(index)
      );
      
      localStorage.setItem("items", JSON.stringify(updatedItems));
      loadItems();
      showSuccessMessage("welcome", `${indicesToRemove.length} item(s) removed successfully.`);
    }

    function updateExistingItems() {
      const items = JSON.parse(localStorage.getItem("items")) || [];
      const checkboxes = document.querySelectorAll(".item-checkbox:checked");
      
      if (checkboxes.length === 0) {
        showSuccessMessage("welcome", "Please select at least one item to update.");
        return;
      }
      
      let updatedCount = 0;
      
      checkboxes.forEach(checkbox => {
        const index = parseInt(checkbox.id.split("-")[1]);
        const item = items[index];
        
        const newName = prompt(`Enter new name for ${item.name}:`, item.name);
        if (newName === null) return; // User cancelled
        
        const newPrice = parseFloat(prompt(`Enter new price for ${newName}:`, item.price));
        if (isNaN(newPrice)) {
          showSuccessMessage("welcome", "Invalid price. Update cancelled for this item.");
          return;
        }
        
        const newQuantity = parseInt(prompt(`Enter new quantity for ${newName}:`, item.quantity));
        if (isNaN(newQuantity)) {
          showSuccessMessage("welcome", "Invalid quantity. Update cancelled for this item.");
          return;
        }
        
        items[index].name = newName.trim();
        items[index].price = newPrice;
        items[index].quantity = newQuantity;
        updatedCount++;
      });
      
      if (updatedCount > 0) {
        localStorage.setItem("items", JSON.stringify(items));
        loadItems();
        showSuccessMessage("welcome", `${updatedCount} item(s) updated successfully.`);
      }
    }

    // User Management Functions
    function toggleUserDetails() {
      const userDetails = document.getElementById("userDetails");
      if (userDetails.style.display === "none") {
        loadUserDetails();
        userDetails.style.display = "block";
        document.querySelector(".toggle-btn").textContent = "Hide User Details";
      } else {
        userDetails.style.display = "none";
        document.querySelector(".toggle-btn").textContent = "Show User Details";
      }
    }

    function loadUserDetails() {
      const userTableBody = document.getElementById("userTableBody");
      userTableBody.innerHTML = "";
      
      // Get all keys from localStorage
      const users = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        // Skip items that are not user accounts (like currentUser, currentAdmin, items, etc.)
        if (!["currentUser", "currentAdmin", "items"].includes(key) && 
            !key.endsWith("_history") && 
            !localStorage.getItem(key).startsWith("{")) { // Skip JSON objects
          users.push(key);
        }
      }
      
      if (users.length === 0) {
        userTableBody.innerHTML = "<tr><td colspan='2'>No users found</td></tr>";
        return;
      }
      
      users.forEach(user => {
        const row = document.createElement("tr");
        row.classList.add("animate__animated", "animate__fadeIn");
        
        const usernameCell = document.createElement("td");
        usernameCell.textContent = user;
        
        const actionsCell = document.createElement("td");
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.onclick = function() { deleteUser(user); };
        deleteButton.classList.add("animate__animated", "animate__pulse", "ripple");
        
        actionsCell.appendChild(deleteButton);
        row.appendChild(usernameCell);
        row.appendChild(actionsCell);
        
        userTableBody.appendChild(row);
      });
    }

    function deleteUser(username) {
      if (confirm(`Are you sure you want to delete user "${username}"? This will also delete their history.`)) {
        localStorage.removeItem(username);
        localStorage.removeItem(`${username}_history`);
        loadUserDetails();
        showSuccessMessage("welcome", `User "${username}" deleted successfully.`);
      }
    }

    // Admin History Management
    function toggleAdminHistory() {
      const adminHistory = document.getElementById("adminHistory");
      if (adminHistory.style.display === "none") {
        loadAdminHistory();
        adminHistory.style.display = "block";
        document.querySelector(".toggle-admin-history").textContent = "Hide All Bill History";
      } else {
        adminHistory.style.display = "none";
        document.querySelector(".toggle-admin-history").textContent = "Show All Bill History";
      }
    }

    function loadAdminHistory() {
      const adminHistoryTableBody = document.getElementById("adminHistoryTableBody");
      adminHistoryTableBody.innerHTML = "";
      
      // Get all users with history
      const usersWithHistory = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.endsWith("_history")) {
          const username = key.replace("_history", "");
          usersWithHistory.push(username);
        }
      }
      
      if (usersWithHistory.length === 0) {
        adminHistoryTableBody.innerHTML = "<tr><td colspan='4'>No bill history found</td></tr>";
        return;
      }
      
      // For each user, get their history and add to table
      usersWithHistory.forEach(username => {
        const history = JSON.parse(localStorage.getItem(`${username}_history`)) || [];
        
        history.forEach((entry, index) => {
          const row = document.createElement("tr");
          row.classList.add("animate__animated", "animate__fadeIn");
          
          const usernameCell = document.createElement("td");
          usernameCell.textContent = username;
          
          const dateCell = document.createElement("td");
          dateCell.textContent = formatDate(entry.date);
          
          const totalCell = document.createElement("td");
          totalCell.textContent = `₹${entry.grandTotal.toFixed(2)}`;
          
          const actionsCell = document.createElement("td");
          const viewButton = document.createElement("button");
          viewButton.textContent = "View";
          viewButton.onclick = function() { viewAdminBillDetails(username, index); };
          viewButton.classList.add("animate__animated", "animate__pulse", "ripple");
          
          const deleteButton = document.createElement("button");
          deleteButton.textContent = "Delete";
          deleteButton.onclick = function() { deleteAdminHistoryItem(username, index); };
          deleteButton.classList.add("animate__animated", "animate__pulse", "ripple");
          
          actionsCell.appendChild(viewButton);
          actionsCell.appendChild(deleteButton);
          row.appendChild(usernameCell);
          row.appendChild(dateCell);
          row.appendChild(totalCell);
          row.appendChild(actionsCell);
          
          adminHistoryTableBody.appendChild(row);
        });
      });
    }

    function viewAdminBillDetails(username, index) {
      const history = JSON.parse(localStorage.getItem(`${username}_history`)) || [];
      if (index >= 0 && index < history.length) {
        document.getElementById("adminHistoryContent").innerHTML = history[index].billContent;
        document.getElementById("adminGrandTotal").textContent = history[index].grandTotal.toFixed(2);
        document.getElementById("adminHistoryDisplay").style.display = "block";
      }
    }

    function hideAdminHistory() {
      document.getElementById("adminHistoryDisplay").style.display = "none";
    }

    function deleteAdminHistoryItem(username, index) {
      if (confirm(`Are you sure you want to delete this bill from ${username}'s history?`)) {
        const history = JSON.parse(localStorage.getItem(`${username}_history`)) || [];
        history.splice(index, 1);
        localStorage.setItem(`${username}_history`, JSON.stringify(history));
        loadAdminHistory();
        showSuccessMessage("welcome", "Bill history item deleted successfully.");
      }
    }

    // Bill Generation
    function generateBill() {
      const items = JSON.parse(localStorage.getItem("items")) || [];
      let billContent = "";
      let grandTotal = 0;
      let insufficientStock = false;
      let hasItems = false;

      for (let i = 0; i < items.length; i++) {
        const quantity = parseInt(document.getElementById(`quantity-${i}`).value) || 0;
        if (quantity > 0) {
          hasItems = true;
          if (quantity > items[i].quantity) {
            insufficientStock = true;
            showSuccessMessage("welcome", `Insufficient stock for ${items[i].name}. Available quantity: ${items[i].quantity}`);
          } else {
            const amount = quantity * items[i].price;
            grandTotal += amount;
            billContent += `<tr><td>${items[i].name}</td><td>${quantity}</td><td>₹${amount.toFixed(2)}</td></tr>`;
            // Update the item quantity in local storage
            items[i].quantity -= quantity;
          }
        }
      }

      if (!hasItems) {
        showSuccessMessage("welcome", "Please select at least one item.");
        return;
      }

      if (grandTotal > 0 && !insufficientStock) {
        document.getElementById("billContent").innerHTML = billContent;
        document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
        document.getElementById("billDisplay").style.display = "block";
        localStorage.setItem("items", JSON.stringify(items)); // Update items in local storage
        saveToHistory(grandTotal, billContent); // Save the bill to history
        showSuccessMessage("billSuccess", "Bill generated successfully!");
      } else if (insufficientStock) {
        showSuccessMessage("welcome", "Please adjust your quantities and try again.");
      }
    }

    function resetValues() {
      const inputs = document.querySelectorAll("input[type=number]");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].id.startsWith("quantity-")) {
          inputs[i].value = 0;
        }
      }
      document.getElementById("billDisplay").style.display = "none";
    }

    // History Management
    function saveToHistory(grandTotal, billContent) {
      if (!currentUser) return;
      
      const history = JSON.parse(localStorage.getItem(`${currentUser}_history`)) || [];
      history.push({ 
        date: new Date().toISOString(),
        grandTotal, 
        billContent 
      });
      localStorage.setItem(`${currentUser}_history`, JSON.stringify(history));
    }

    function viewHistory() {
      if (!currentUser) {
        showSuccessMessage("welcome", "Please login to view history.");
        return;
      }
      
      const history = JSON.parse(localStorage.getItem(`${currentUser}_history`)) || [];
      
      let historyContent = "";
      if (history.length === 0) {
        historyContent = "<tr><td colspan='3'>No history available</td></tr>";
      } else {
        history.forEach((entry, index) => {
          historyContent += `
            <tr class="animate__animated animate__fadeIn">
              <td>${formatDate(entry.date)}</td>
              <td><button onclick="viewBillDetails(${index})" class="ripple">View Bill ${index + 1}</button></td>
              <td>₹${entry.grandTotal.toFixed(2)}</td>
            </tr>`;
        });
      }
      
      document.getElementById("historyContent").innerHTML = historyContent;
      document.getElementById("historyDisplay").style.display = "block";
    }

    function hideHistory() {
      document.getElementById("historyDisplay").style.display = "none";
    }

    function viewBillDetails(index) {
      if (!currentUser) return;
      
      const history = JSON.parse(localStorage.getItem(`${currentUser}_history`)) || [];
      if (index >= 0 && index < history.length) {
        const billDetails = history[index].billContent;
        document.getElementById("billContent").innerHTML = billDetails;
        document.getElementById("grandTotal").textContent = history[index].grandTotal.toFixed(2);
        document.getElementById("billDisplay").style.display = "block";
      }
    }

    function clearHistory() {
      if (!currentUser) {
        showSuccessMessage("welcome", "Please login to clear history.");
        return;
      }
      
      if (confirm("Are you sure you want to clear all your calculation history?")) {
        localStorage.removeItem(`${currentUser}_history`);
        document.getElementById("historyContent").innerHTML = "";
        showSuccessMessage("welcome", "History cleared successfully.");
      }
    }

    // Initialize the app
    window.onload = function() {
      // Check if we're coming from a refresh and already past preloader
      if (currentUser || currentAdmin) {
        document.getElementById('preloader').style.display = 'none';
        checkExistingSession();
      } else {
        // Start preloader animation only if no existing session
        simulateProgress();
      }
    };
  </script>
</body>
</html>